@model IEnumerable<DrawingTheme.Models.tblComponent>
@{
    ViewBag.Title = "DrawShape";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int i = 0;
    //Layout = null;
}



<div class="row mb-2">
    <div class="container-fluid bd-example">
        <nav class="col-md-12  navbar navbar-expand-lg navbar-light light-primary-bg" style="display:block !important">

            <input type="text" name="OrderId" id="OrderId" value="" hidden="">


            <button id="Area" class="btn btn-success ml-2 mr-2" onclick="SaveData(4)" data-radius="30" data-width="100" data-height="40" data-angle="180" data-rotation="45">Lawn</button>
            <button id="DryArea" class="btn mr-2" style="background-color: #ffe699;" onclick="SaveData(5)" data-radius="30" data-width="100" data-height="40" data-angle="180" data-rotation="45">Dry Area</button>
            <button id="Hedge" class="btn mr-2" style="background-color: #D2BFFF;" onclick="SaveData(6)" data-radius="30" data-width="100" data-height="40" data-angle="180" data-rotation="45">Hedge</button>
            <button id="GetWet" class="btn mr-2" style="background-color: rgba(111, 187, 211, .8);" onclick="SaveData(9)" data-radius="30" data-width="100" data-height="40" data-angle="180" data-rotation="45">Get Wet </button>

           
                <form  style="float:right" role="form" id="payment-form" method="POST" action="@Url.Action("PaymentWithPaypal","PayPal")">
                    <span class="badge badge-warning  mr-2"> Total Amount: <label id="TotalAmount"> 0</label> €</span>
                    <input type="text" id="TotalAmountInput" name="amount" value="" hidden />
                    <button class="btn btn-primary " type="button" id="save"><i class="fa fa-save mr-2"></i>Save as PDF</button>
                    <button class="btn btn-info mr-2" type="submit"><i class="fa fa-paypal mr-2"></i> Place Order</button>
                </form>
           
        </nav>
    </div>

</div>

<div class="row">
    <div class="container-fluid   col-md-1">
        <div class="card">
            @foreach (DrawingTheme.Models.tblCategory item in ViewBag.Category)
            {

                <div class="dropdown " id="btn_@item.Code" style="padding:10px;">
                    <button type="button" class="btn btn-outline-secondary " data-toggle="dropdown">
                        <img src="@item.Component" style="width:80%" />
                    </button>
                    <div class="dropdown-menu" style="overflow: scroll; height: 400px; will-change: transform; position: absolute; transform: translate3d(0px, 34px, 0px); top: 0px; left: 0px;" x-placement="bottom-start">

                        @foreach (DrawingTheme.Models.tblSubCategory item1 in ViewBag.SubCategory)
                        {
                            if (@item1.CategoryID == item.CategoryID)
                            {
                                <a class="dropdown-item" id="@item.Code" data-SubCatId="@item1.SubcategoryID" data-Name="@item1.SubcategoryName" data-radius="@item1.ThrowDistanceMax" data-width="@item1.ThrowWidth" data-height="@item1.ThrowHeight" data-angle="@item1.MaxAngle" data-rotation="@item1.MinAngle" data-IrrigationCircles="@item1.valveboxcircle" data-Filter="@item1.valveboxFilter" data-DrinkingWater="@item1.drinkingwatersource" data-WellWater="@item1.wellwatersource" data-RainWater="@item1.rainwatersource" data-Station="@item1.IrrigationComputermaxstation" data-Indoor="@item1.IrrigationComputerindoor" data-Outdoor="@item1.IrrigationComputeroutdoor" data-SP="@item1.IrrigationComputeroutdoor" href="javascript:void(0)">
                                    @item1.SubcategoryName
                                </a>
                            }


                        }
                    </div>

                </div>
            }
        </div>
        @*<div class="navigation navbar navbar-light justify-content-center px-3 px-lg-2 py-2 py-md-3  ver-menu">

            <ul class="nav navbar-nav flex-row flex-lg-column flex-grow-1 justify-content-start align-items-center py-2 py-lg-0">

                @foreach (DrawingTheme.Models.tblCategory item in ViewBag.Category)
                {

                    <li class="collapsed">
                        <a class="m-link" data-toggle="collapse" data-target="#@item.Code" href="#">
                            <i class="" style="margin-left:4%"></i>
                            <span>@item.CategoryName</span><span class="arrow fa fa-angle-down ml-auto text-right"></span>
                        </a>
                        <ul class="sub-menu collapse" id="@item.Code">
                            @foreach (DrawingTheme.Models.tblSubCategory item1 in ViewBag.SubCategory)
                            {
                                if (@item1.CategoryID == item.CategoryID)
                                {






                                    <li>
                                        <a id="@item.Code" data-SubCatId="@item1.SubcategoryID" data-Name="@item1.SubcategoryName" data-radius="@item1.ThrowDistanceMax" data-width="@item1.ThrowWidth" data-height="@item1.ThrowHeight" data-angle="@item1.MaxAngle" data-rotation="@item1.MinAngle" data-IrrigationCircles="@item1.valveboxcircle" data-Filter="@item1.valveboxFilter" data-DrinkingWater="@item1.drinkingwatersource" data-WellWater="@item1.wellwatersource" data-RainWater="@item1.rainwatersource" data-Station="@item1.IrrigationComputermaxstation" data-Indoor="@item1.IrrigationComputerindoor" data-Outdoor="@item1.IrrigationComputeroutdoor" data-SP="@item1.IrrigationComputeroutdoor" href="javascript:void(0)">
                                            @item1.SubcategoryName
                                        </a>
                                    </li>


                                }
                            }
                        </ul>
                    </li>
}



            </ul>

        </div>*@




    </div>
    <div class="col-md-9">
        <div class="body d-flex profile-page">
            <div class="card container-fluid">
                        <div class="card-body" id="container">
                        </div>
            </div>
        </div>

    </div>
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-header">
                <h4>Property</h4>
            </div>
            <div class="card-body ">
                <h6 id="SName"></h6>
                <h6 hidden id="SubCatId"></h6>
                <div id="RSPD" style="display:none;">
                    <input class="form-control" type="text" id="SId" hidden name="name" value="" />
                    <label>Radius</label>
                    <input class="form-control" type="number" id="SRadius" onchange="SetS(this,1)" name="name" value="" />
                    <label>Start Angle</label>
                    <input class="form-control" type="number" id="StartAngle" onchange="SetS(this,2)" name="name" value="" />
                    <label>Angle</label>
                    <input class="form-control" type="number" id="SAngle" onchange="SetS(this,3)" name="name" value="" />
                    <button class="btn" id="BtnEndsprinkler" style="display:none; background-color:aqua;">End sprinkler</button>
                </div>
                <div id="SSPD" style="display:none;">
                    <input class="form-control" type="text" id="SSId" hidden name="name" value="" />
                    <label>Width</label>
                    <input class="form-control" type="number" id="SSWidth" onchange="SetS(this,4)" name="name" value="" />
                    <label>Height</label>
                    <input class="form-control" type="number" id="SSHeight" onchange="SetS(this,5)" name="name" value="" />
                    <button class="btn" id="BtnEndRectangularsprinkler" style="display:none;background-color:aqua;">End rectangular sprinkler</button>
                </div>
                <div id="VBPD" style="display:none;">
                    <input class="form-control" type="text" id="VBId" hidden name="name" value="" />
                    <label id="VBF" style="display:none;">Filter included</label>
                    <label id="VBDW" style="display:none;">for drinking water source</label>
                    <label id="VBWW" style="display:none;">for well water source</label>
                    <label id="VBRW" style="display:none;">for rainwater source</label>
                    <button class="btn" id="EndVB" style="display:none;background-color:aqua;">End Valve box</button>
                </div>
                <div id="ICPD" style="display:none;">
                    <input class="form-control" type="text" id="ICId" hidden name="name" value="" />
                    <label id="ICS">Filter included</label>
                    <label id="ICID" style="display:none;">Indoor</label>
                    <label id="ICOD" style="display:none;">outdoor</label>
                    <label id="ICSP" style="display:none;">Smarphone</label>
                    <button class="btn" id="EndIC" style="display:none;background-color:aqua;">End Irrigation computer</button>
                </div>
                <div id="TapPD" style="display:none;">
                    <input class="form-control" type="text" id="TapId" hidden name="name" value="" />
                    <select id="TapSelect" onchange="SetS(this,6)">
                        <option value="70">Drinking Water Source</option>
                        <option value="71">Well Water Source</option>
                        <option value="72">Rain Water Source</option>
                    </select>
                    <button class="btn" id="EndTap" style="display:none;background-color:aqua;">End Tap</button>
                </div>

                <input type="file" class="form-control" id="file_input" accept="image/*" name="name" value="">
                <div id="DivImageOpacityValue" style="display:none;">
                    <label>Image opacity</label>
                    <input type="range" class="form-control" id="ImageOpacityValue" min="10" max="100" value="100">
                </div>

                <button class="btn btn-danger text-center mt-1"  id="UndoCanvas"><i class="fa fa-undo mr-1"></i>Undo</button>
            </div>
        </div>
       
    </div>
    </div>




<div class="modal fade" id="addcontact" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog " role="document">

        <div class="modal-content">
            <div class="modal-header">
                <h4 class="title" id="defaultModalLabel">Enter order name</h4>
            </div>
            <div class="modal-body">

                <div class="row clearfix">
                    <div class="col-12">
                        <div class="form-group">
                            <input type="text" class="form-control" id="ModalName" name="Name" placeholder="Order Name" required>
                        </div>
                    </div>


                </div>

            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" id="SaveOrder">Save Changes</button>
            </div>
        </div>
    </div>
</div>


<script src="https://unpkg.com/konva@8.3.14/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>
<script src="~/assets/js/jquery-3.2.1.min.js"></script>
<script>

    function SaveData(id) {
        ComponentId = id;
        OrderId = $("#OrderId").val();

        var model = {
            ComponentId: ComponentId,
            OrderId: OrderId,
        };

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddOrderDetails", "Customer")",
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                $("#TotalAmount").text(r);
                $("#TotalAmountInput").val(r);
            }
        });

    }


    $(document).on("click", "#SaveOrder", function () {

        var Name = $("#ModalName").val();

        var model = {
            Name: Name,
        };


        $.ajax({
            type: "POST",
            url: "@Url.Action("AjaxAddOrder", "Customer")",
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                $("#OrderId").val(r);
                $("#addcontact").modal('toggle');
            }
        });


    });


    $(document).ready(function () {

        //$("#addcontact").modal('toggle');
        //$('#addcontact').modal({ backdrop: 'static', keyboard: false })
    
        $("#btnChangeImage").click();
        ChangeImage();
        $("#SideBAr").addClass("sidebar-mini");
        $("#addcontact").modal('toggle');
    });

        var width = 1000;
        var height = 500;

        var isDraw = false;
        var isFirst = false;
        var isFinished = false;
        var isFirstMouseMove = true;
        var isStartLine = true;
        var isOverOnStarting = false;
        var isInArea = false;
        var isOutArea = false;
        var poly = null;
        var rect =  null;
        const Points = [];
        const StartRect = [];
        var Name = 1;
        var TextId = 1;
        var Rect1;
        var PolyName = 1;
        var TapName = 1;
        var SystemName = 1;
        var ValveBoxName = 1;
        var UndoArray = [];
        var SprinklerName=1;
        var RectangularSprinklerName=1;
        var id = "";
        var CurrentObjId = "Line1";
        var FillCirFirstTime = true;
        var EndSprinkler = true;
        var CurretSprinkler = "";
        var CurretRSprinkler = "";
        var CurretRectangularSprinkler = "";
        var CurretIC = "";
    var CurretTap = "";
    var CurretVB = "";
        var CountnueRotate = true;



        const Group = new Konva.Group();
        var stage = new Konva.Stage({
            container: 'container',
        width: width,
        height: height,
      });

        var layer = new Konva.Layer();

        stage.on('pointerdown', MouseDownHandler);
        stage.on('pointermove', MouseMoveHandler);
        //stage.on('pointerover', handleMouseOverStartPoint);
        stage.add(layer);


        $("body").on("click", "#Area", function () {
            //alert(this.id);
            poly = new Konva.Line({
                points: [0, 0],
                stroke: 'black',
                strokeWidth: 3,
                lineCap: 'round',
                lineJoin: 'round',
                id: "Line" + PolyName + "",
                listening: false,
                name: "Area",
            });

            poly.on('pointerdown', function () {
                    //alert(this.id()); //Should show 'IDofImg'
                    if (this.id()=="Line1") {
                isInArea = true;
                    }

                });

            poly.on('pointerout', function () {
                isOutArea = true;
            console.log(isOutArea);

                });

            poly.on('pointerenter', function () {
                isOutArea = false;
            console.log(isOutArea);
                });


            PolyName += 1;
            layer.add(poly);
            isOverOnStarting = false;
            isStartLine = true;
            isFinished = false;
            isFirstMouseMove = true;

            CurrentObjId = poly.name();

            id = poly.id();
            //alert(poly.name());
            //if (this.id == "Area") {
            //    id = "Line1";
            //    }
            //else if (this.id == "DryArea") {
            //    id = "Line2";
            //    }
            $("#Area").prop('disabled', true);

            UndoArray.push(poly.id());
        });


        $("body").on("click", "#DryArea", function () {
            //alert(this.id);
            poly = new Konva.Line({
                points: [0, 0],
                stroke: 'black',
                strokeWidth: 3,
                lineCap: 'round',
                lineJoin: 'round',
                id: "Line" + PolyName + "",
                listening: false,
                name: "DryArea",
            });

            poly.on('pointerdown', function () {
                    //alert(this.id()); //Should show 'IDofImg'
                    //console.log("Line Dry"+" "+this.id());
                if (this.id() == "Line1") {
                isInArea = true;
                    }
                });

            poly.on('pointerout', function () {
                isOutArea = true;
            console.log(isOutArea);

                });

            poly.on('pointerenter', function () {
                isOutArea = false;
            console.log(isOutArea);
                });


            PolyName += 1;
            layer.add(poly);
            isOverOnStarting = false;
            isStartLine = true;
            isFinished = false;
            isFirstMouseMove = true;

            CurrentObjId = poly.name();

                id = poly.id();
            //if (this.id == "Area") {
            //    id = "Line1";
            //    }
            //else if (this.id == "DryArea") {
            //    id = poly.id();
            //        //alert(poly.name() + this.id);
            //}
            UndoArray.push(poly.id());
        });


    $("body").on("click", "#Hedge", function () {
            //alert(this.id);
            poly = new Konva.Line({
                points: [0, 0],
                stroke: 'black',
                strokeWidth: 3,
                lineCap: 'round',
                lineJoin: 'round',
                id: "Line" + PolyName + "",
                listening: false,
                name: "Hedge",
            });

            //poly.on('pointerdown', function () {
            //    if (this.id() == "Line1") {
            //    isInArea = true;
            //        }
            //    });

            //poly.on('pointerout', function () {
            //    isOutArea = true;
            //console.log(isOutArea);

            //    });

            //poly.on('pointerenter', function () {
            //    isOutArea = false;
            //console.log(isOutArea);
            //    });


            PolyName += 1;
            layer.add(poly);
            isOverOnStarting = false;
            isStartLine = true;
            isFinished = false;
            isFirstMouseMove = true;
        CurrentObjId = poly.name();
        id = poly.id();

        UndoArray.push(poly.id());
     });


    $("body").on("click", "#GetWet", function () {
            //alert(this.id);
            poly = new Konva.Line({
                points: [0, 0],
                stroke: 'black',
                strokeWidth: 3,
                lineCap: 'round',
                lineJoin: 'round',
                id: "Line" + PolyName + "",
                listening: false,
                name: "GetWet",
            });

            //poly.on('pointerdown', function () {
            //    if (this.id() == "Line1") {
            //    isInArea = true;
            //        }
            //    });

            //poly.on('pointerout', function () {
            //    isOutArea = true;
            //console.log(isOutArea);

            //    });

            //poly.on('pointerenter', function () {
            //    isOutArea = false;
            //console.log(isOutArea);
            //    });


            PolyName += 1;
            layer.add(poly);
            isOverOnStarting = false;
            isStartLine = true;
            isFinished = false;
            isFirstMouseMove = true;

        CurrentObjId = poly.name();


        id = poly.id();

        UndoArray.push(poly.id());
     });


    $("body").on("click", "#TAP", function () {
        //alert(this.id);
        //var imageObj = new Image();
        //imageObj.onload = function () {
        //    var yoda = new Konva.Image({
        //        x: 50,
        //        y: 50,
        //        image: imageObj,
        //        width: 25,
        //        height: 25,
        //        id: "Tap" + TapName,
        //        draggable: true,
        //    });
        //    TapName += 1;
        //    // add the shape to the layer
        //    layer.add(yoda);
        //    UndoArray.push(yoda.id());
        //};
        //imageObj.src = '/assets/images/ecommerce/Tap.png';

        if (CurretTap != "") {
            var SubName = $(this).attr("data-Name");
            var SubId = $(this).attr("data-SubCatId");
            $("#SName").text(SubName);
            $("#SubCatId").text(SubId);
            $("#TapSelect").val(SubId);

        }
        else {


            var SubName = $(this).attr("data-Name");
            var SubId = $(this).attr("data-SubCatId");
            $("#TapSelect").val(SubId);



            Konva.Image.fromURL(
                '/assets/images/ecommerce/Tap.png',
                (img) => {
                    img.setAttrs({
                        x: 50,
                        y: 50,
                        width: 25,
                        height: 25,
                        id: "Tap" + TapName,
                        draggable: true,
                    });
                    layer.add(img);
                    UndoArray.push(img.id());
                    $("#SName").text(SubName);
                    $("#SubCatId").text(SubId);
                    $("#TapId").val(img.id());
                    CurretTap=img.id();
                    // apply default left-top crop
                    //applyCrop('center-middle');

                    const tr = new Konva.Transformer({
                        nodes: [img],
                        keepRatio: true,
                        enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
                        id: img.id().replace("Tap", "TTap")
                    });

                    layer.add(tr);
                    tr.anchorCornerRadius(10);
                    tr.rotateEnabled(false);
                }
            );
        }

        $("#TapPD").show();
        $("#EndTap").show();

    });


    $("body").on("click", "#EndTap", function () {

        //$("#Sprinkler").prop('disabled', false);
        //

        SubCategoryID = $("#SubCatId").text();
        SubcategoryName = $("#SName").text();
        UniqueId = $("#TapId").val();
        OrderId = $("#OrderId").val();

        $("#EndTap").hide();
        $("#TapPD").hide();
        $("#SName").text("");
        $("#SubCatId").text("");
        $("#btn_TAP *").prop('disabled', true);

        var model = {
            UniqueId: UniqueId,
            SubCategoryID: SubCategoryID,
            SubcategoryName: SubcategoryName,
            OrderId: OrderId,
        };

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddOrderDetails", "Customer")",
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                $("#TotalAmount").text(r);
                $("#TotalAmountInput").val(r);
            }
        });
    });



    $("body").on("click", "#IC", function () {
        //alert(this.id);
        //var imageObj = new Image();
        //imageObj.onload = function () {
        //    var yoda = new Konva.Image({
        //        x: 50,
        //        y: 50,
        //        image: imageObj,
        //        width: 25,
        //        height: 25,
        //        id: "System" + SystemName,
        //        draggable: true,
        //    });
        //    SystemName += 1;
        //    // add the shape to the layer
        //    layer.add(yoda);
        //    UndoArray.push(yoda.id());
        //};
        //imageObj.src = '/assets/images/ecommerce/System.png';

        if (CurretIC != "") {
            var Station = $(this).attr("data-Station");
            var InDoor = $(this).attr("data-InDoor");
            var OutDoor = $(this).attr("data-OutDoor");
            var SP = $(this).attr("data-SP");
            var SubName = $(this).attr("data-Name");
            var SubId = $(this).attr("data-SubCatId");
            $("#SName").text(SubName);
            $("#SubCatId").text(SubId);
            $("#ICS").text(Station);
            if (InDoor == "True") {
                $("#ICID").show();
            }
            if (OutDoor == "True") {
                $("#ICOD").show();
            }
            if (SP == "True") {
                $("#ICSP").show();
            }
        }
        else {

            var Station = $(this).attr("data-Station");
            var InDoor = $(this).attr("data-InDoor");
            var OutDoor = $(this).attr("data-OutDoor");
            var SP = $(this).attr("data-SP");
            var SubName = $(this).attr("data-Name");
            var SubId = $(this).attr("data-SubCatId");
            $("#ICS").text(Station);
            if (InDoor == "True") {
                $("#ICID").show();
            }
            if (OutDoor == "True") {
                $("#ICOD").show();
            }
            if (SP == "True") {
                $("#ICSP").show();
            }



            Konva.Image.fromURL(
                '/assets/images/ecommerce/System.png',
                (img) => {
                    img.setAttrs({
                        x: 50,
                        y: 50,
                        width: 25,
                        height: 25,
                        id: "System" + SystemName,
                        draggable: true,
                    });
                    layer.add(img);
                    UndoArray.push(img.id());

                    $("#SName").text(SubName);
                    $("#SubCatId").text(SubId);
                    $("#ICId").val(img.id());
                    CurretIC = img.id();
                    // apply default left-top crop
                    //applyCrop('center-middle');

                    const tr = new Konva.Transformer({
                        nodes: [img],
                        keepRatio: true,
                        enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
                        id: img.id().replace("System", "TIC")
                    });

                    layer.add(tr);
                    tr.anchorCornerRadius(10);
                    tr.rotateEnabled(false);
                }
            );
        }

        $("#ICPD").show();
        $("#EndIC").show();




    });


    $("body").on("click", "#EndIC", function () {

        //$("#Sprinkler").prop('disabled', false);
        //

        SubCategoryID = $("#SubCatId").text();
        SubcategoryName = $("#SName").text();
        UniqueId = $("#ICId").val();
        OrderId = $("#OrderId").val();

        $("#EndIC").hide();
        $("#ICPD").hide();
        $("#SName").text("");
        $("#SubCatId").text("");
        //$("#btn_IC").prop("disabled", true);
        $("#btn_IC *").prop('disabled', true);


        var model = {
            UniqueId: UniqueId,
            SubCategoryID: SubCategoryID,
            SubcategoryName: SubcategoryName,
            OrderId: OrderId,
        };

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddOrderDetails", "Customer")",
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                $("#TotalAmount").text(r);
                $("#TotalAmountInput").val(r);
            }
        });
    });


    $("body").on("click", "#VB", function () {
        //var imageObj = new Image();
        //imageObj.onload = function () {
        //    var yoda = new Konva.Image({
        //        x: 50,
        //        y: 50,
        //        image: imageObj,
        //        width: 25,
        //        height: 25,
        //        id: "ValveBox" + ValveBoxName,
        //        draggable: true,
        //    });
        //    ValveBoxName += 1;
        //    // add the shape to the layer
        //    layer.add(yoda);
        //    UndoArray.push(yoda.id());
        //};
        //imageObj.src = '/assets/images/ecommerce/ValveBox.png';


        if (CurretVB != "") {
            var Filter = $(this).attr("data-Filter");
            var DrinkingWater = $(this).attr("data-DrinkingWater");
            var WellWater = $(this).attr("data-WellWater");
            var RainWater = $(this).attr("data-RainWater");
            var SubName = $(this).attr("data-Name");
            var SubId = $(this).attr("data-SubCatId");
            $("#SName").text(SubName);
            $("#SubCatId").text(SubId);
            if (Filter == "True") {
                $("#VBF").show();
            }
            if (DrinkingWater == "True") {
                $("#VBDW").show();
            }
            if (WellWater == "True") {
                $("#VBWW").show();
            }
            if (RainWater == "True") {
                $("#VBRW").show();
            }
        }
        else {


            var Filter = $(this).attr("data-Filter");
            var DrinkingWater = $(this).attr("data-DrinkingWater");
            var WellWater = $(this).attr("data-WellWater");
            var RainWater = $(this).attr("data-RainWater");
            var SubName = $(this).attr("data-Name");
            var SubId = $(this).attr("data-SubCatId");
            if (Filter == "True") {
                $("#VBF").show();
            }
            if (DrinkingWater == "True") {
                $("#VBDW").show();
            }
            if (WellWater == "True") {
                $("#VBWW").show();
            }
            if (RainWater == "True") {
                $("#VBRW").show();
            }


            Konva.Image.fromURL(
                '/assets/images/ecommerce/ValveBox.png',
                (img) => {
                    img.setAttrs({
                        x: 50,
                        y: 50,
                        width: 25,
                        height: 25,
                        id: "ValveBox" + ValveBoxName,
                        draggable: true,
                    });
                    layer.add(img);
                    UndoArray.push(img.id());

                    $("#SName").text(SubName);
                    $("#SubCatId").text(SubId);
                    $("#VBId").val(img.id());
                    CurretVB = img.id();
                    // apply default left-top crop
                    //applyCrop('center-middle');

                    const tr = new Konva.Transformer({
                        nodes: [img],
                        keepRatio: true,
                        enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
                        id: img.id().replace("ValveBox", "TVB")
                    });

                    layer.add(tr);
                    tr.anchorCornerRadius(10);
                    tr.rotateEnabled(false);
                }
            );
        }

        $("#VBPD").show();
        $("#EndVB").show();

    });


    $("body").on("click", "#RSP,#Sprinkler1,#Sprinkler2", function () {
        $("#RSPD").show();
        var Radius = MToPx(Number($(this).attr("data-radius")));
        var Angle = Number($(this).attr("data-Angle"));
        var Rotation = Number($(this).attr("data-Rotation"));
        var SubName = $(this).attr("data-Name");
        var SubId = $(this).attr("data-SubCatId");
        if (CurretSprinkler != "") {
            var node = layer.findOne('#' + CurretSprinkler);
            var x = node.x();
            var y = node.y();
            node.destroy();
            var node = layer.findOne('#' + CurretSprinkler.replace("Sprinkler", "FillCircle"));
            if (node != null) {
                node.destroy();
            }
            var node = layer.findOne('#' + CurretSprinkler.replace("Sprinkler", "Circle"));
            if (node != null) {
                node.destroy();
            }
            var node = layer.findOne('#' + CurretSprinkler.replace("Sprinkler", "Arc"));
            if (node != null) {
                node.destroy();
            }

            var circle = new Konva.Circle({
                x: x,
                y: y,
                radius: Radius,
                //fill: 'red',
                stroke: 'black',
                strokeWidth: 1,
                id: "Sprinkler" + SprinklerName + "",
                name: "Sprinkler",

            });

            var cir = new Konva.Circle({
                x: x - circle.radius(),
                y: y,
                radius: 5,
                //fill: 'red',
                stroke: 'black',
                strokeWidth: 1,
                id: circle.id().replace("Sprinkler", "Circle"),
                draggable: true,
            });

            cir.on('dragmove', (e) => {

                updateSprinkler(e.target.id());

            });

            layer.add(cir);

            var cirFill = new Konva.Circle({
                x: x + circle.radius(),
                y: y,
                radius: 5,
                //fill: 'red',
                stroke: 'black',
                strokeWidth: 1,
                id: circle.id().replace("Sprinkler", "FillCircle"),
                draggable: true,
            });

            cirFill.on('dragmove', (e) => {

                updateSprinkler(e.target.id());
            });

            layer.add(cirFill);

            var ArcCir = new Konva.Arc({
                x: x,
                y: y,
                innerRadius: circle.radius(),
                angle: Angle - Rotation,
                fill: 'lightblue',
                stroke: 'black',
                strokeWidth: 0,
                id: circle.id().replace("Sprinkler", "Arc"),
                //draggable: true,
                listening: false,
                rotation: Rotation,
            });


            layer.add(ArcCir);


        }
        else {
            var circle = new Konva.Circle({
                x:-100,
                y: -100 ,
                radius: Radius,
                //fill: 'red',
                stroke: 'black',
                strokeWidth: 1,
                id: "Sprinkler" + SprinklerName + "",
                name: "Sprinkler",

            });


            isOverOnStarting = false;
            isStartLine = true;
            isFinished = false;
            isFirstMouseMove = true;

        }

        //alert(Radius);




        CurretSprinkler = circle.id();

        //console.log(UndoArray);
        SprinklerName += 1;


            layer.add(circle);

        //alert(poly.name());
        id = circle.id();
        CurrentObjId = circle.name();
        //$("#Area").prop('disabled', true);
        UndoArray.push(circle.id());

        $("#SId").val(circle.id());
        $("#SRadius").val(PxToM(circle.radius()));
        $("#StartAngle").val(Rotation);
        $("#SAngle").val(Angle);
        $("#SName").text(SubName);
        $("#SubCatId").text(SubId);

        //$("#Sprinkler").prop('disabled', true);
        $("#BtnEndsprinkler").show();
    });

    function PxToM(Val) {

        return (Number(Val) / 12);

    }

    function MToPx(Val) {

        return (Number(Val) * 12);

    }

    $("body").on("click", "#BtnEndsprinkler", function () {

        //$("#Sprinkler").prop('disabled', false);
        //

        var SubCategoryID = $("#SubCatId").text();
        var SubcategoryName = $("#SName").text();
        var UniqueId = $("#SId").val();
        var MinAngle = $("#StartAngle").val();
        var MaxAngle = $("#SAngle").val();
        var ThrowDistanceMax = $("#SRadius").val();
        var OrderId = $("#OrderId").val();

        $("#BtnEndsprinkler").hide();
        $("#RSPD").hide();
        $("#SName").text("");
        CurretSprinkler = "";


        var model = {
            UniqueId: UniqueId,
            SubCategoryID: SubCategoryID,
            SubcategoryName: SubcategoryName,
            MinAngle: MinAngle,
            MaxAngle: MaxAngle,
            ThrowDistanceMax: ThrowDistanceMax,
            OrderId: OrderId,
        };

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddOrderDetails", "Customer")",
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                $("#TotalAmount").text(r);
                $("#TotalAmountInput").val(r);
            }
        });


    });

    $("body").on("click", "#EndVB", function () {

        //$("#Sprinkler").prop('disabled', false);
        //

        SubCategoryID = $("#SubCatId").text();
        SubcategoryName = $("#SName").text();
        UniqueId = $("#VBId").val();
        OrderId = $("#OrderId").val();

        $("#EndVB").hide();
        $("#VBPD").hide();
        $("#SName").text("");
        $("#SubCatId").text("");
        //CurretSprinkler = "";
        $("#btn_VB *").prop('disabled', true);


        var model = {
            UniqueId: UniqueId,
            SubCategoryID: SubCategoryID,
            SubcategoryName: SubcategoryName,
            OrderId: OrderId,
        };

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddOrderDetails", "Customer")",
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                $("#TotalAmount").text(r);
                $("#TotalAmountInput").val(r);
            }
        });
    });



    $("body").on("click", "#SSP", function () {
        $("#SSPD").show();
        var SubName = $(this).attr("data-Name");
        var Width = MToPx(Number($(this).attr("data-Width")));
        var Height = MToPx(Number($(this).attr("data-Height")));
        var SubId = $(this).attr("data-SubCatId");
        if (CurretRSprinkler != "") {
            var node = layer.findOne('#' + CurretRSprinkler);
            var x = node.x();
            var y = node.y();
            node.destroy();
            var node = layer.findOne('#' + CurretRSprinkler.replace("RectangularSprinkler", "TRS"));
            if (node != null) {
                node.destroy();
            }
            var node = layer.findOne('#' + CurretRSprinkler.replace("RectangularSprinkler", "RSCircle"));
            if (node != null) {
                node.destroy();
            }



            var circle = new Konva.Rect({
                x: x,
                y: y,
                width: Width,
                height: Height,
                //fill: 'green',
                stroke: 'black',
                strokeWidth: 1,
                id: "RectangularSprinkler" + RectangularSprinklerName + "",
                name: "RectangularSprinkler",

            });


            circle.on('pointerclick', (e) => {

                //console.log(e.evt.button);

                if (e.evt.button === 0) {
                    var TSprinkler = layer.findOne('#' + e.target.id().replace("RectangularSprinkler", "TRS"));
                    TSprinkler.rotateEnabled(true);

                }
                else if (e.evt.button === 2) {

                    var TSprinkler = layer.findOne('#' + e.target.id().replace("RectangularSprinkler", "TRS"));
                    TSprinkler.rotateEnabled(false);
                }

            });


            var cir = new Konva.Circle({
                x: x,
                y: y,
                radius: 5,
                //fill: 'red',
                stroke: 'black',
                strokeWidth: 1,
                id: circle.id().replace("RectangularSprinkler", "RSCircle"),
                draggable: true,
            });

            cir.on('pointerclick', (e) => {

                //console.log(e.evt.button);

                if (e.evt.button === 0) {
                    var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                    Sprinkler.rotation(Sprinkler.rotation() + 1);

                }
                else if (e.evt.button === 2) {

                    var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                    Sprinkler.rotation(Sprinkler.rotation() - 1);
                }

            });

            cir.on('dragmove', (e) => {
                //updateRSSprinkler(e.target.id());

                var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                Sprinkler.x(e.target.x());
                Sprinkler.y(e.target.y());
            });

            layer.add(cir);

            var transformer = new Konva.Transformer({
                nodes: [circle, cir],
                rotateAnchorOffset: 60,
                enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
                id: circle.id().replace("RectangularSprinkler", "TRS")
            });
            layer.add(transformer);

            transformer.anchorCornerRadius(10);
            transformer.borderEnabled(false);
            transformer.resizeEnabled(false);
            transformer.rotateAnchorOffset(0);


        }
        else {
            //alert(Radius);
            var circle = new Konva.Rect({
                x: 50,
                y: 50,
                width: Width,
                height: Height,
                //fill: 'green',
                stroke: 'black',
                strokeWidth: 1,
                id: "RectangularSprinkler" + RectangularSprinklerName + "",
                name: "RectangularSprinkler",

            });


            circle.on('pointerclick', (e) => {

                //console.log(e.evt.button);

                if (e.evt.button === 0) {
                    var TSprinkler = layer.findOne('#' + e.target.id().replace("RectangularSprinkler", "TRS"));
                    TSprinkler.rotateEnabled(true);

                }
                else if (e.evt.button === 2) {

                    var TSprinkler = layer.findOne('#' + e.target.id().replace("RectangularSprinkler", "TRS"));
                    TSprinkler.rotateEnabled(false);
                }

            });


            var cir = new Konva.Circle({
                x: 50,
                y: 50,
                radius: 5,
                //fill: 'red',
                stroke: 'black',
                strokeWidth: 1,
                id: circle.id().replace("RectangularSprinkler", "RSCircle"),
                draggable: true,
            });

            cir.on('pointerclick', (e) => {

                //console.log(e.evt.button);

                if (e.evt.button === 0) {
                    var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                    Sprinkler.rotation(Sprinkler.rotation() + 1);

                }
                else if (e.evt.button === 2) {

                    var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                    Sprinkler.rotation(Sprinkler.rotation() - 1);
                }

            });

            cir.on('dragmove', (e) => {
                //updateRSSprinkler(e.target.id());

                var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                Sprinkler.x(e.target.x());
                Sprinkler.y(e.target.y());
            });

            layer.add(cir);

            var transformer = new Konva.Transformer({
                nodes: [circle, cir],
                rotateAnchorOffset: 60,
                enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
                id: circle.id().replace("RectangularSprinkler", "TRS")
            });
            layer.add(transformer);

            transformer.anchorCornerRadius(10);
            transformer.borderEnabled(false);
            transformer.resizeEnabled(false);
            transformer.rotateAnchorOffset(0);

        }






        CurretRSprinkler = circle.id();

        //console.log(UndoArray);
        RectangularSprinklerName += 1;
        layer.add(circle);
        isOverOnStarting = false;
        isStartLine = true;
        isFinished = false;
        isFirstMouseMove = true;

        id = circle.id();
        CurrentObjId = circle.name();
        UndoArray.push(circle.id());

        $("#SSId").val(circle.id());
        $("#SName").text(SubName);
        $("#SSWidth").val(PxToM(circle.width()));
        $("#SSHeight").val(PxToM(circle.height()));
        $("#SubCatId").text(SubId);


        $("#BtnEndRectangularsprinkler").show();
    });

    $("body").on("click", "#BtnEndRectangularsprinkler", function () {

        //$("#Sprinkler").prop('disabled', false);




        SubCategoryID = $("#SubCatId").text();
        SubcategoryName = $("#SName").text();
        UniqueId = $("#SSId").val();
        OrderId = $("#OrderId").val();

        $("#BtnEndRectangularsprinkler").hide();
        $("#SSPD").hide();
        $("#SName").text("");
        CurretRSprinkler = "";


        var model = {
            UniqueId: UniqueId,
            SubCategoryID: SubCategoryID,
            SubcategoryName: SubcategoryName,
            OrderId: OrderId,
        };

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddOrderDetails", "Customer")",
            data: JSON.stringify(model),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                $("#TotalAmount").text(r);
                $("#TotalAmountInput").val(r);
            }
        });


    });


    stage.on('contextmenu', (e) => {
        e.evt.preventDefault();
    });

        function MouseDownHandler() {
            //console.log(this);
            //if (this.pointerClickStartShape != undefined) {
            //    id = this.pointerClickStartShape.attrs.id;
            //    console.log(id);
            //    //if (id[0]=="R") {
            //    //    id = FindIndex(id);
            //    //}
            //}
            if (isOverOnStarting == false && isFinished == false) {
                if (CurrentObjId == "Sprinkler") {
                    var circle = layer.findOne('#' + id);

                    var Position = stage.getPointerPosition();
                    circle.x(Position.x);
                    circle.y(Position.y);



                    var cir = new Konva.Circle({
                        x: Position.x - circle.radius(),
                        y: Position.y ,
                        radius: 5,
                        //fill: 'red',
                        stroke: 'black',
                        strokeWidth: 1,
                        id: id.replace("Sprinkler","Circle"),
                        draggable: true,
                    });

                    cir.on('dragmove', (e) => {


                        //var sprinkler = layer.findOne('#' + e.target.id().replace("Circle", "Sprinkler"));
                        //// update nodes from the new state
                        ////console.log(e);
                        //e.target.y(sprinkler.y());
                        updateSprinkler(e.target.id());

                    });

                    layer.add(cir);

                    var cirFill = new Konva.Circle({
                        x: Position.x + circle.radius(),
                        y: Position.y ,
                        radius: 5,
                        //fill: 'red',
                        stroke: 'black',
                        strokeWidth: 1,
                        id: id.replace("Sprinkler", "FillCircle"),
                        draggable: true,
                    });

                    cirFill.on('dragmove', (e) => {

                        // update nodes from the new state

                        //var sprinkler = layer.findOne('#' + e.target.id().replace("FillCircle", "Sprinkler"));
                        //var x1 = e.target.x();
                        //var y1 = e.target.y();
                        //var x2 = sprinkler.x();
                        //var y2 = sprinkler.y();

                        //var dx = x1 - x2;
                        //var dy = y1 - y2;
                        //var Sumsqr = Math.pow(dx, 2);
                        //Sumsqr += Math.pow(dy, 2);
                        //var Distance = Math.sqrt(Sumsqr);
                        //var Radius = sprinkler.radius();


                        //console.log(Distance + " " + Radius);
                        //if (Distance > Radius+3 || Distance < Radius-3) {
                        //    e.target.draggable(false);
                        //    e.target.x(x2 + Radius);
                        //    e.target.y(y2);
                        //}

                        /*console.log(e);*/
                        //updateSprinkler(e.target.id());



                        //var x1 = 0;
                        //var y1 = 0;
                        //var x2 = 0;
                        //var y2 = 0;
                        //var Sprinkler = layer.findOne('#' + e.target.id().replace("FillCircle", "Sprinkler"));
                        //x1 = e.target.x();
                        //y1 = e.target.y();
                        //x2 = Sprinkler.x();
                        //y2 = Sprinkler.y();
                        //dx = x1 - x2;
                        //dy = y1 - y2;
                        //var angleRad1 = Math.atan2(dy, dx);
                        //var angleDeg1 = angleRad1 * 180 / Math.PI;
                        //angleDeg1 = (360 + (angleDeg1)) % 360;

                        //console.log("Drag Angle " + angleDeg1);



                        updateSprinkler(e.target.id());


                    });

                    layer.add(cirFill);




                    var ArcCir = new Konva.Arc({
                        x: Position.x,
                        y: Position.y,
                        innerRadius: circle.radius(),
                        angle: 180,
                        fill: 'lightblue',
                        stroke: 'black',
                        strokeWidth: 0,
                        id: id.replace("Sprinkler", "Arc"),
                        //draggable: true,
                        listening: false,
                        rotation: 0,
                    });

                    //var arc = new Konva.Arc({
                    //    x: Position.x,
                    //    y: Position.y - 20,
                    //    innerRadius: circle.radius(),
                    //    angle: 60,
                    //    fill: 'yellow',
                    //    stroke: 'black',
                    //    strokeWidth: 4,
                    //    id: id.replace("Sprinkler", "arc"),
                    //    draggable: true,
                    //});


                    layer.add(ArcCir);


                    isFinished = true;
                }
                else if (CurrentObjId == "RectangularSprinkler")
                {
                    //var circle = layer.findOne('#' + id);

                    //var Position = stage.getPointerPosition();
                    //circle.x(Position.x);
                    //circle.y(Position.y);

                    //var cir = new Konva.Circle({
                    //    x: Position.x ,
                    //    y: Position.y,
                    //    radius: 5,
                    //    //fill: 'red',
                    //    stroke: 'black',
                    //    strokeWidth: 1,
                    //    id: id.replace("RectangularSprinkler", "RSCircle"),
                    //    draggable: true,
                    //});

                    //cir.on('pointerclick', (e) => {

                    //    //console.log(e.evt.button);

                    //    if (e.evt.button === 0) {
                    //            var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                    //            Sprinkler.rotation(Sprinkler.rotation() + 1);

                    //    }
                    //    else if (e.evt.button === 2) {

                    //        var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                    //        Sprinkler.rotation(Sprinkler.rotation() - 1);
                    //    }

                    //});

                    //cir.on('dragmove', (e) => {
                    //    //updateRSSprinkler(e.target.id());

                    //    var Sprinkler = layer.findOne('#' + e.target.id().replace("RSCircle", "RectangularSprinkler"));
                    //    Sprinkler.x(e.target.x());
                    //    Sprinkler.y(e.target.y());
                    //});

                    //layer.add(cir);
                    //    var Sprinkler = layer.findOne('#' + id);

                    //var transformer = new Konva.Transformer({
                    //    nodes: [Sprinkler, cir],
                    //    rotateAnchorOffset: 60,
                    //    enabledAnchors: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],
                    //    id: id.replace("RectangularSprinkler", "TRS")
                    //});
                    //layer.add(transformer);

                    //transformer.anchorCornerRadius(10);
                    //transformer.borderEnabled(false);
                    //transformer.resizeEnabled(false);
                    //transformer.rotateAnchorOffset(0);

                    //transformer.stopTransform(true);
                    //var cirFill = new Konva.Circle({
                    //    x: Position.x ,
                    //    y: Position.y,
                    //    radius: 5,
                    //    //fill: 'red',
                    //    stroke: 'black',
                    //    strokeWidth: 1,
                    //    id: id.replace("Sprinkler", "FillRSCircle"),
                    //    draggable: true,
                    //});

                    //cirFill.on('pointerclick', (e) => {
                    //    e.target.rotation(e.target.rotation + 1);
                    //});

                    //cirFill.on('pointerdblclick', (e) => {
                    //    e.target.rotation(e.target.rotation + 1);
                    //});

                    //cirFill.on('dragmove', (e) => {
                    //    //updateRSSprinkler(e.target.id());
                    //});

                    //layer.add(cirFill);

                    //var ArcCir = new Konva.Arc({
                    //    x: Position.x,
                    //    y: Position.y,
                    //    innerRadius: circle.radius(),
                    //    angle: 180,
                    //    fill: 'lightblue',
                    //    stroke: 'black',
                    //    strokeWidth: 0,
                    //    id: id.replace("Sprinkler", "Arc"),
                    //    //draggable: true,
                    //    listening: false,
                    //    rotation: 0,
                    //});


                    //layer.add(ArcCir);


                    isFinished = true;
                }
                else if (id[0] == 'L') {
                    console.log(id);
                    var line = layer.findOne('#' + id);
                    if (isInArea == true || (line.name() != "DryArea" && line.name() != "GetWet")) {
                        //var line = layer.findOne('#' + id);
                        //console.log(line.id());
                        var points = line.points();
                        if (isStartLine == true) {

                            points.pop();
                            points.pop();
                            //points.pop();
                            //points.pop();
                        }
                        isDraw = true;
                        var Position = stage.getPointerPosition();
                        //Points.push(Position.x, Position.y);
                        points.push(Position.x, Position.y);
                        line.points(points);
                        //console.log(line.points());


                        rect = new Konva.Rect({
                            x: Position.x - 5,
                            y: Position.y - 5,
                            width: 10,
                            height: 10,
                            name: "Rect" + Name + "",
                            id: "Rect" + Name + "",
                            //fill: 'green',
                            stroke: 'red',
                            strokeWidth: 2,
                            draggable: true,
                        });
                        if (isStartLine == true) {
                            StartRect.push(rect.id());
                            isStartLine = false;
                        }

                        Name += 1;
                        rect.on('pointerenter', function () {
                            var id = this.name();
                            console.log(id);
                            var LineId = 0;
                            if (id[0] == "R") {
                                LineId = FindIndex(id);
                            }
                            console.log(LineId);
                            var line = layer.findOne('#Line' + LineId);
                            var points = line.points();
                            var pointerPos = stage.getPointerPosition();
                            if (isFinished == true || points.length < 6) {
                                return;
                            }
                            else if (CheckFirstIndex(id)) {
                                //var Rect1 = stage.find('.' + id);
                                isOverOnStarting = true;
                                //console.log(isOverOnStarting);

                            }

                        });


                        rect.on("pointerout", function () {

                            if (CheckFirstIndex(this.name())) {
                                isOverOnStarting = false;
                                //console.log(isOverOnStarting);
                                //layer.batchDraw();
                            }
                        });



                        rect.on('dragmove', (e) => {

                            // update nodes from the new state
                            //console.log(e);
                            updateObjects(e.target.id());

                        });

                        /*rect.moveToTop();*/

                        layer.add(rect);


                        //var S = line.points();
                        var S = line.points().slice();
                        //console.log(line.points());
                        //if (rect.name()=="Rect2") {
                        //    S.pop();
                        //    S.pop();
                        //}
                        S.pop();
                        S.pop();
                        //console.log(S);
                        //console.log(S.length - 1);
                        //console.log(S.length - 2);
                        //console.log(S.length - 3);
                        //console.log(S.length - 4);
                        //alert(S[S.length - 1]+" = "+S[1]);

                        var x = (S[S.length - 4] + S[S.length - 2]) / 2;
                        var y = (S[S.length - 3] + S[S.length - 1]) / 2;
                        var dx = S[S.length - 2] - S[S.length - 4];
                        var dy = S[S.length - 1] - S[S.length - 3];
                        var Sumsqr = Math.pow(dx, 2);
                        Sumsqr += Math.pow(dy, 2);
                        var Distance = Math.sqrt(Sumsqr);
                        Distance /=  12;
                        Distance = Distance.toFixed(2);
                        var angleRad = Math.atan(dy / dx);
                        var angleDeg = angleRad * 180 / Math.PI;
                        var Text = new Konva.Text({
                            text: Distance+" m",
                            fontSize: 10,
                            fontFamily: 'Calibri',
                            fill: '#000',
                            //width: poly.width(),
                            rotation: angleDeg,
                            padding: -20,
                            y: y,
                            x: x,
                            id: "Text" + TextId + "",
                        });

                        TextId += 1;
                        layer.add(Text);

                        //poly.moveToBottom();
                        if (CheckFirstIndex(rect.name())) {
                            Rect1 = layer.findOne('.' + rect.name());
                            //rect.moveToTop();
                        }
                        Rect1.moveToTop();
                        isInArea = false;
                    }

                }


            }
            else {
                if (CurrentObjId == "Sprinkler" || CurrentObjId == "RectangularSprinkler") {
                    //var circle = layer.findOne('#' + id);
                    //var Position = stage.getPointerPosition();
                    //circle.x(Position.x);
                    //circle.y(Position.y);


                }
                else {
                    var LineId = 0;
                    //console.log(this.pointerClickStartShape.attrs.id);
                    //console.log(id);
                    //if (id[0] == "R") {
                    //    LineId = FindIndex(id);
                    //}
                    //else {
                    //    LineId = id[4];
                    //}
                    var line = layer.findOne('#' + id);
                    isDraw = false;

                    isFinished = true;
                    line.closed(true);
                    line.listening(true);
                    //console.log(line.name());
                    if (line.name() == "Area") {
                        line.fill("lightgreen");

                    }
                    else if (line.name() == "DryArea") {
                        line.fill("#ffe699");
                    }
                    else if (line.name() == "Hedge") {
                        line.fill("#D2BFFF");
                    }
                    else if (line.name() == "GetWet") {
                        line.fill("rgba(111, 187, 211, .8)");
                    }
                }


                //var CheckPoint = [709.6000366210938, 232.80003356933594];
                //console.log(line.points());
                //inside(CheckPoint, line.points());

                return;
            }

        }

        function updateObjects(id) {
                    var LineId = 0;
                    var x1 = 0;
                    var y1 = 0;
                    var x2 = 0;
                    var y2 = 0;
                    var node = layer.findOne('#' + id);
                    if (id[0] == "R") {
                        LineId = FindIndex(id);
                    }
                    //console.log(LineId);
                    var line = layer.findOne('#Line' + LineId);
                    var points = line.points();
                    //line.destroy();
                    var ID =Number(id.replace('Rect', ''));
                    var MOD = FindMOD(id);
                    //console.log(MOD);
                    //console.log(ID);
                    if (CheckFirstIndex(id)) {
                            var Index = 0;
                        if (MOD == 0) {
                            Index = ((ID * 2) - 2) ;
                                }
                        else {
                            Index = ((ID * 2) - 2) % MOD;
                                }
                        line.closed(false);
                        points[Index] = node.x() + 5;
                        points[Index + 1] = node.y() + 5;
                        points[points.length - 2] = node.x() + 5;
                        points[points.length - 1] = node.y() + 5;




                        x1 = Index
                        y1 = Index + 1
                        x2 = Index + 2
                        y2 = Index + 3

                        var TextId = FindDragTextId(id);

                        var EText = layer.findOne('#' + TextId[0]);
                        //console.log(EText);

                        var S = line.points().slice();

                        x1 = points[x1];
                        x2 = points[x2];
                        y1 = points[y1];
                        y2 = points[y2];
                        var x = (x2 + x1) / 2;
                        var y = (y2 + y1) / 2;
                        var dx = x1 - x2;
                        var dy = y1 - y2;
                        var Sumsqr = Math.pow(dx, 2);
                        Sumsqr += Math.pow(dy, 2);
                        var Distance = Math.sqrt(Sumsqr);
                        Distance /= 12;
                        Distance = Distance.toFixed(2);
                        var angleRad = Math.atan(dy / dx);
                        var angleDeg = angleRad * 180 / Math.PI;

                        EText.text(Distance.toString() + " m");
                        EText.rotation(angleDeg);
                        EText.y(y);
                        EText.x(x);

                        var RectCId = TextId[1].replace('Text', '');
                        MOD = FindMOD(RectCId);
                        //console.log(MOD);
                        if (MOD == 0) {
                            Index = ((RectCId * 2) - 2);
                                }
                        else {
                            Index = ((RectCId * 2) - 2) % MOD;
                                }
                        //Index = ((RectCId * 2) - 2) % MOD;

                        var EText = layer.findOne('#' + TextId[1]);

                        x1 = Index
                        y1 = Index + 1
                        x2 = Index + 2
                        y2 = Index + 3

                        var S = line.points().slice();

                        x1 = points[x1];
                        x2 = points[x2];
                        y1 = points[y1];
                        y2 = points[y2];
                        var x = (x2 + x1) / 2;
                        var y = (y2 + y1) / 2;
                        var dx = x1 - x2;
                        var dy = y1 - y2;
                        var Sumsqr = Math.pow(dx, 2);
                        Sumsqr += Math.pow(dy, 2);
                        var Distance = Math.sqrt(Sumsqr);
                        Distance /= 12;
                        Distance = Distance.toFixed(2);
                        var angleRad = Math.atan(dy / dx);
                        var angleDeg = angleRad * 180 / Math.PI;

                        EText.text(Distance.toString() + " m");
                        EText.rotation(angleDeg);
                        EText.y(y);
                        EText.x(x);


                            //console.log(FindDragTextId(id));

                     }
                    else {
                            var Index = 0;
                        if (MOD == 0) {
                            Index = ((ID * 2) - 2);
                                }
                        else {
                            Index = ((ID * 2) - 2) % MOD;
                                }
                        line.closed(false);
                        points[Index] = node.x() + 5;
                        points[Index + 1] = node.y() + 5;

                        x1=Index-2
                        y1=Index-1
                        x2=Index
                        y2=Index+1

                        var TextId = FindDragTextId(id);
                        var EText = layer.findOne('#' + TextId[1]);
                        //console.log(EText);

                        var S = line.points().slice();
                                //console.log(line.points());
                                //if (rect.name()=="Rect2") {
                            //    S.pop();
                            //    S.pop();
                            //}
                            //S.pop();
                            //S.pop();
                            //console.log(EText);
                            //console.log(S.length - 1);
                            //console.log(S.length - 2);
                            //console.log(S.length - 3);
                            //console.log(S.length - 4);
                            //alert(S[S.length - 1]+" = "+S[1]);
                            x1 = points[x1];
                        x2 = points[x2];
                        y1 = points[y1];
                        y2 = points[y2];
                        var x = (x2 + x1) / 2;
                        var y = (y2 + y1) / 2;
                        //console.log(x);
                        //console.log(y);
                        var dx = x1 - x2;
                        var dy =y1 - y2;
                        var Sumsqr = Math.pow(dx, 2);
                        Sumsqr += Math.pow(dy, 2);
                        var Distance = Math.sqrt(Sumsqr);
                        Distance /= 12;
                        Distance = Distance.toFixed(2);
                        //console.log(Distance);
                        var angleRad = Math.atan(dy / dx);
                        var angleDeg = angleRad * 180 / Math.PI;

                        EText.text(Distance.toString() + " m");
                        EText.rotation(angleDeg);
                        EText.y(y);
                        EText.x(x);





                        x1 = Index
                        y1 = Index+1
                        x2 = Index+2
                        y2 = Index + 3

                        var TextId = FindDragTextId(id);
                        var EText = layer.findOne('#' + TextId[0]);
                        //console.log(EText);

                        var S = line.points().slice();

                        x1 = points[x1];
                        x2 = points[x2];
                        y1 = points[y1];
                        y2 = points[y2];
                        var x = (x2 + x1) / 2;
                        var y = (y2 + y1) / 2;
                        var dx = x1 - x2;
                        var dy = y1 - y2;
                        var Sumsqr = Math.pow(dx, 2);
                        Sumsqr += Math.pow(dy, 2);
                        var Distance = Math.sqrt(Sumsqr);
                        Distance /= 12;
                        Distance = Distance.toFixed(2);
                        var angleRad = Math.atan(dy / dx);
                        var angleDeg = angleRad * 180 / Math.PI;

                        EText.text(Distance.toString() + " m");
                        EText.rotation(angleDeg);
                        EText.y(y);
                        EText.x(x);




                            //console.log(FindDragTextId(id));
                        }
                    line.closed(true);
                }


    function updateSprinkler(id) {
        var LineId = 0;
        var x1 = 0;
        var y1 = 0;
        var x2 = 0;
        var y2 = 0;
        var circle = null;

        var FillCircle = null;
        var Sprinkler = null;
        var ArcCir = null;
        if (id[0] == "C") {
            circle = layer.findOne('#' + id);
            FillCircle = layer.findOne('#' + id.replace("Circle", "FillCircle"));
        }
        else {
             FillCircle= layer.findOne('#' + id);
            circle= layer.findOne('#' + id.replace("FillCircle", "Circle"));
        }

        if (id[0] == "C") {
            Sprinkler = layer.findOne('#' + id.replace("Circle", "Sprinkler"));
        }
        else {
            Sprinkler = layer.findOne('#' + id.replace("FillCircle", "Sprinkler"));
        }

        if (id[0] == "C") {
            ArcCir = layer.findOne('#' + id.replace("Circle", "Arc"));
        }
        else {
            ArcCir = layer.findOne('#' + id.replace("FillCircle", "Arc"));
        }

        if (id[0] == "C") {
            x1 = circle.x();
            y1 = circle.y();
            x2 = Sprinkler.x();
            y2 = Sprinkler.y();
            ArcCir = layer.findOne('#' + id.replace("Circle", "Arc"));
        }
        else {
            x1 = FillCircle.x();
            y1 = FillCircle.y();
            x2 = Sprinkler.x();
            y2 = Sprinkler.y();
            ArcCir = layer.findOne('#' + id.replace("FillCircle", "Arc"));
        }



        var dx = x1 - x2;
        var dy = y1 - y2;
        var Sumsqr = Math.pow(dx, 2);
        Sumsqr += Math.pow(dy, 2);
        var Distance = Math.sqrt(Sumsqr);
        //Distance = Distance.toFixed(2);
        var oldRadius = Sprinkler.radius();
        Sprinkler.radius(Distance);


        if (id[0] == "C") {

            x1 = FillCircle.x();
            y1 = FillCircle.y();
        }
        else {
            x1 = circle.x();
            y1 = circle.y();
        }





        dx = x1 - x2;
        dy = y1 - y2;


        // Sumsqr = Math.pow(dx, 2);
        //Sumsqr += Math.pow(dy, 2);
        // Distance = Math.sqrt(Sumsqr);
        var angleRad1 = Math.atan2(dy, dx);
        var angleDeg1 = angleRad1 * 180 / Math.PI;
        angleDeg1 = (360 + (angleDeg1)) % 360;
        //var angleRad = Math.atan2(dy , dx);
        //var angleDeg = angleRad * 180 / Math.PI;
        //angleDeg = (360 + (angleDeg)) % 360;

        //console.log(x1+ " " +x2);
        //console.log(y1 + " " + y2);

        //console.log("Angle " + angleDeg1);
        var DiffRadius = Number(Distance - oldRadius).toFixed(5);
        console.log("Diffin Radius " + DiffRadius);
        //console.log("Sprinkler.Radius() " + Sprinkler.radius());
        //console.log("Sprinkler.x() " + Sprinkler.x());
        //console.log("Sprinkler.y() " + Sprinkler.y());

        if (angleDeg1 == 0) {
            if (id[0] == "C") {

                FillCircle.x(Sprinkler.x() + Sprinkler.radius());
            }
            else {
                circle.x(Sprinkler.x() + Sprinkler.radius());
            }

        }
        else if (angleDeg1 == 180) {
            if (id[0] == "C") {

                FillCircle.x(Sprinkler.x() - Sprinkler.radius());
            }
            else {
                circle.x(Sprinkler.x() - Sprinkler.radius());
            }

        }
        else if (angleDeg1 == 90) {
            if (id[0] == "C") {

                FillCircle.y(Sprinkler.y() + Sprinkler.radius());
            }
            else {
                circle.y(Sprinkler.y() + Sprinkler.radius());
            }
        }
        else if (angleDeg1 == 270) {
            if (id[0] == "C") {

                FillCircle.y(Sprinkler.y() - Sprinkler.radius());
            }
            else {
                circle.y(Sprinkler.y() - Sprinkler.radius());
            }

        }
        else if (angleDeg1 < 90) {
            if (id[0] == "C") {
                var setx = Number(FillCircle.x()) + Number(DiffRadius );
                var sety = Number(FillCircle.y()) + Number(DiffRadius );
                //console.log("Oldx " + FillCircle.x());
                //console.log("Oldy " + FillCircle.y());
                //console.log("Newx " + setx);
                //console.log("Newy " + sety);
                //console.log("Diffx " + (setx - FillCircle.x()));
                //console.log("Diffy " + (sety - FillCircle.y()));
                FillCircle.x(setx);
                FillCircle.y(sety);
            }
            else {
                var setx = Number(circle.x()) + Number(DiffRadius);
                var sety = Number(circle.y()) + Number(DiffRadius);
                circle.x(setx);
                circle.y(sety);
            }
            //console.log("FillCircle.x() " + FillCircle.x());
            //console.log("FillCircle.y() " + FillCircle.y());
        }
        else if (angleDeg1 < 180) {

            if (id[0] == "C") {

                var setx = Number(FillCircle.x()) - Number(DiffRadius);
                var sety = Number(FillCircle.y()) + Number(DiffRadius);
                FillCircle.x(setx);
                FillCircle.y(sety);
            }
            else {
                var setx = Number(circle.x()) - Number(DiffRadius);
                var sety = Number(circle.y()) + Number(DiffRadius);
                circle.x(setx);
                circle.y(sety);
                circle.x(setx);
            }

            //FillCircle.x(Sprinkler.x() - Sprinkler.radius());
            //FillCircle.y(Sprinkler.y() + Sprinkler.radius());
        }
        else if (angleDeg1 < 270) {

            if (id[0] == "C") {

                var setx = Number(FillCircle.x()) - Number(DiffRadius);
                var sety = Number(FillCircle.y()) - Number(DiffRadius);
                FillCircle.x(setx);
                FillCircle.y(sety);
            }
            else {

                var setx = Number(circle.x()) - Number(DiffRadius);
                var sety = Number(circle.y()) - Number(DiffRadius);
                circle.x(setx);
                circle.y(sety);
            }
            //FillCircle.x(Sprinkler.x() - Sprinkler.radius());
            //FillCircle.y(Sprinkler.y() - Sprinkler.radius());
        }
        else if (angleDeg1 < 360) {


            if (id[0] == "C") {

                var setx = Number(FillCircle.x()) + Number(DiffRadius);
                var sety = Number(FillCircle.y()) - Number(DiffRadius);
                FillCircle.x(setx);
                FillCircle.y(sety);
            }
            else {

                var setx = Number(circle.x()) + Number(DiffRadius);
                var sety = Number(circle.y()) - Number(DiffRadius);
                circle.x(setx);
                circle.y(sety);
            }
            //FillCircle.x(Sprinkler.x() + Sprinkler.radius());
            //FillCircle.y(Sprinkler.y() - Sprinkler.radius());
        }

        x1 = FillCircle.x();
        y1 = FillCircle.y();
        dx = x1 - x2;
        dy = y1 - y2;
        var StartangleRad1 = Math.atan2(dy, dx);
        var StartangleDeg = StartangleRad1 * 180 / Math.PI;
        StartangleDeg = (360 + (StartangleDeg)) % 360;
        console.log("StartangleDeg "+StartangleDeg);
        ArcCir.rotation(StartangleDeg);

        x1 = circle.x();
        y1 = circle.y();
        dx = x1 - x2;
        dy = y1 - y2;
         angleRad1 = Math.atan2(dy, dx);
         angleDeg1 = angleRad1 * 180 / Math.PI;
        angleDeg1 = (360 + (angleDeg1)) % 360;
        angleDeg1 = angleDeg1 - StartangleDeg;

        ArcCir.innerRadius(Distance);
        ArcCir.angle(angleDeg1);

        $("#SId").val(Sprinkler.id());
        $("#SRadius").val(Sprinkler.radius().toFixed(2));
        $("#StartAngle").val(ArcCir.rotation().toFixed(2));

        $("#SAngle").val(ArcCir.angle().toFixed(2));


        //console.log("FillCircle Radius " + angleDeg1);

        //FillCircle.x(Sprinkler.x() + Sprinkler.radius());
    }


    function updateRSSprinkler(id) {
        var LineId = 0;
        var x1 = 0;
        var y1 = 0;
        var x2 = 0;
        var y2 = 0;
        var circle = null;

        var FillCircle = null;
        var Sprinkler = null;
        var ArcCir = null;
        if (id[0] == "C") {
            circle = layer.findOne('#' + id);
            FillCircle = layer.findOne('#' + id.replace("RSCircle", "FillRSCircle"));
        }
        else {
             FillCircle= layer.findOne('#' + id);
            circle = layer.findOne('#' + id.replace("FillRSCircle", "RSCircle"));
        }

        if (id[0] == "C") {
            Sprinkler = layer.findOne('#' + id.replace("RSCircle", "RectangularSprinkler"));
        }
        else {
            Sprinkler = layer.findOne('#' + id.replace("FillRSCircle", "RectangularSprinkler"));
        }

        //if (id[0] == "C") {
        //    ArcCir = layer.findOne('#' + id.replace("Circle", "Arc"));
        //}
        //else {
        //    ArcCir = layer.findOne('#' + id.replace("FillCircle", "Arc"));
        //}

        if (id[0] == "C") {
            x1 = circle.x();
            y1 = circle.y();
            x2 = Sprinkler.x();
            y2 = Sprinkler.y();
            //ArcCir = layer.findOne('#' + id.replace("Circle", "Arc"));

            var dx = x1 - x2;
            var dy = y1 - y2;
            var Sumsqr = Math.pow(dx, 2);
            Sumsqr += Math.pow(dy, 2);
            var Distance = Math.sqrt(Sumsqr);
            //Distance = Distance.toFixed(2);
            //var oldRadius = Sprinkler.radius();
            Sprinkler.width(Distance);
        }
        else {
            x1 = FillCircle.x();
            y1 = FillCircle.y();
            x2 = Sprinkler.x();
            y2 = Sprinkler.y();
            //ArcCir = layer.findOne('#' + id.replace("FillCircle", "Arc"));


            var dx = x1 - x2;
            var dy = y1 - y2;

            var angleRad1 = Math.atan2(dy, dx);
            var angleDeg1 = angleRad1 * 180 / Math.PI;
            angleDeg1 = (360 + (angleDeg1)) % 360;
            var DiffRadius = Number(Distance - oldRadius).toFixed(5);
        }






        //if (id[0] == "C") {

        //    x1 = FillCircle.x();
        //    y1 = FillCircle.y();
        //}
        //else {
        //    x1 = circle.x();
        //    y1 = circle.y();
        //}









        x1 = FillCircle.x();
        y1 = FillCircle.y();
        dx = x1 - x2;
        dy = y1 - y2;
        var StartangleRad1 = Math.atan2(dy, dx);
        var StartangleDeg = StartangleRad1 * 180 / Math.PI;
        StartangleDeg = (360 + (StartangleDeg)) % 360;
        console.log("StartangleDeg "+StartangleDeg);
        ArcCir.rotation(StartangleDeg);

        x1 = circle.x();
        y1 = circle.y();
        dx = x1 - x2;
        dy = y1 - y2;
         angleRad1 = Math.atan2(dy, dx);
         angleDeg1 = angleRad1 * 180 / Math.PI;
        angleDeg1 = (360 + (angleDeg1)) % 360;
        angleDeg1 = angleDeg1 - StartangleDeg;

        ArcCir.innerRadius(Distance);
        ArcCir.angle(angleDeg1);

        //$("#SId").val(Sprinkler.id());
        //$("#SRadius").val(Sprinkler.radius().toFixed(2));
        //$("#StartAngle").val(ArcCir.rotation().toFixed(2));

        //$("#SAngle").val(ArcCir.angle().toFixed(2));
    }

        //function handleMouseOverStartPoint () {
            //    if (isFinished || Points.length < 3) {
            //        alert();
            //        return;
            //    }
            //    else
            //    {
            //        //rect.scale(2, 2);
            //        rect.fill("red");
            //        //layer.batchDraw();
            //    }
            //};

            function MouseMoveHandler() {
                //  //var id = 0;
                if (!isDraw) {
                    //poly.closed = true;
                    return false;
                }
                else {
                    //if (this.mouseClickStartShape != undefined) {

                    //    id = this.mouseClickStartShape.attrs.id;
                    //    console.log(id);
                    //}
                    if (isOutArea == false) {
                        var line = layer.findOne('#' + id);
                        var points = line.points();
                        if (isFirstMouseMove == false) {
                            points.pop();
                            points.pop();
                        }

                        var TextId = FindTextId(rect.id());
                        var EText = layer.findOne('#' + TextId);





                        var CPoints = [];
                        //var line = layer.findOne('#Line');
                        //var points = line.points();
                        Position = stage.getPointerPosition();


                        var S = line.points().slice();
                        //console.log(line.points());
                        //if (rect.name()=="Rect2") {
                        //    S.pop();
                        //    S.pop();
                        //}
                        //S.pop();
                        //S.pop();
                        //console.log(EText);
                        //console.log(S.length - 1);
                        //console.log(S.length - 2);
                        //console.log(S.length - 3);
                        //console.log(S.length - 4);
                        //alert(S[S.length - 1]+" = "+S[1]);

                        var x = (Position.x + S[S.length - 2]) / 2;
                        var y = (Position.y + S[S.length - 1]) / 2;
                        //console.log(x);
                        //console.log(y);
                        var dx = S[S.length - 2] - Position.x;
                        var dy = S[S.length - 1] - Position.y;
                        var Sumsqr = Math.pow(dx, 2);
                        Sumsqr += Math.pow(dy, 2);
                        var Distance = Math.sqrt(Sumsqr);
                        Distance /= 12;
                        Distance = Distance.toFixed(2);
                        //console.log(Distance);
                        //var angleRad = Math.atan(dy / dx);
                        var angleRad = Math.atan(dy/ dx);
                        var angleDeg = angleRad * 180 / Math.PI;
                        //angleDeg = (360 + (angleDeg)) % 360;
                        //console.log("Angle " + angleDeg);
                        EText.text(Distance.toString() + " m");
                        EText.rotation(angleDeg);
                        EText.y(y);
                        EText.x(x);


                        //points.push(Position.x, Position.y);
                        points.push(Position.x, Position.y);
                        CPoints = points.slice();
                        line.points(CPoints);
                        isFirstMouseMove = false;
                        //layer.batchDraw();

                        //line.points(CPoints);
                    }


                }
            }

        function FindMOD(id) {
            var RetIndex = "";
        id = id.replace('Rect', '');
        var CStartRect = StartRect.slice();
        for (var i = 0; i < StartRect.length; i++) {
            CStartRect[i] = CStartRect[i].replace('Rect', '');
        if (Number(CStartRect[i]) === Number(id)) {
            RetIndex = CStartRect[i];
                }
        else {
                    if (Number(id) > Number(CStartRect[i])) {
            RetIndex = CStartRect[i];
                    }
                }
            }
        var Mod = (Number(RetIndex) * 2) - 2;
        return Mod;
        }


        function FindTextId(id) {
            var RectId = id.replace('Rect', '');
        var TextId = "Text" + RectId;
        return TextId;

        }


        function FindDragTextId(id) {

            var TextIds = [];
        var RectId = Number(id.replace('Rect', ''));
        TextIds.push("Text" + RectId);
        if (CheckFirstIndex(id)) {
            //console.log();
            var LastIndex = FindLastId(id)
            console.log(id);
            console.log(LastIndex);
            TextIds.push("Text" + LastIndex.replace('Rect', ''));
            }
        else {
            TextIds.push("Text" + (RectId - 1));
            }

        return TextIds;

        }


        function FindLastId(id) {
            var RetIndex = 0;
        id = id.replace('Rect', '');
        var CStartRect = StartRect.slice();
        for (var i = 0; i < StartRect.length; i++) {
            CStartRect[i] = CStartRect[i].replace('Rect', '');
                if (Number(CStartRect[i]) > Number(id)) {

                    var RetId = "Rect" + (Number(CStartRect[i]) - 1);
                    console.log("RetId " + RetId);
                     return RetId;
                }
        RetIndex = i;
            }
        var RetId = "Rect" + (Name - 1);
            //alert(Name);

        return RetId;
        }



        function FindIndex(id) {
            var RetIndex = 0;
        id = id.replace('Rect', '');
        var CStartRect = StartRect.slice();
        for (var i = 0; i < StartRect.length; i++) {
            CStartRect[i] = CStartRect[i].replace('Rect', '');
        if (Number(CStartRect[i]) == Number(id)) {

                    return i + 1;
                }
        else {
                    if (Number(id) > Number(CStartRect[i]))
        {
            RetIndex = i + 1;
                    }
                }
            }
        return RetIndex;
        }


        function CheckFirstIndex(id) {
            for (var i = 0; i < StartRect.length; i++) {
                if (StartRect[i] == id) {
                    return true;
                }
            }
        return false;
        }



    $("body").on("click", "#UndoCanvas", function () {
        if (UndoArray.length > 0) {
            var CLastId = UndoArray[UndoArray.length - 1];
            console.log(CLastId);
            if (CLastId =="UploadImg") {
                $("#file_input").prop('disabled', false);
            }
            var FirstId = "";
            var LastId = "";

            if (CLastId[0] == 'L') {
                var temp = Number(CLastId.replace("Line", ""));
                FirstId = StartRect[temp - 1];
                LastId = FindLastId(FirstId);
                for (var i = Number(FirstId.replace("Rect", "")); i <= Number(LastId.replace("Rect", "")); i++) {
                    var node = layer.findOne('#Rect' + i);
                    node.destroy();
                    node = layer.findOne('#Text' + i);
                    node.destroy();
                }

            }
            else if (CLastId[0] == 'S' && CLastId[1] == 'p') {

                var node = layer.findOne('#' + CLastId.replace("Sprinkler", "FillCircle"));
                if (node != null) {
                    if (CurretSprinkler != "") {
                        CurretSprinkler = "";
                    }
                    $("#SName").text("");
                    $("#RSPD").hide();
                    node.destroy();
                }
                var node = layer.findOne('#' + CLastId.replace("Sprinkler", "Circle"));
                if (node != null) {
                    node.destroy();
                }
                var node = layer.findOne('#' + CLastId.replace("Sprinkler", "Arc"));
                if (node != null) {
                    node.destroy();
                }

            }
            else if (CLastId[0] == 'R' && CLastId[1] == 'e') {

                var node = layer.findOne('#' + CLastId.replace("RectangularSprinkler", "RSCircle"));
                if (node != null) {
                    if (CurretRSprinkler != "") {
                        CurretRSprinkler = "";
                    }
                    $("#SName").text("");
                    $("#SSPD").hide();
                    node.destroy();
                }
                var node = layer.findOne('#' + CLastId.replace("RectangularSprinkler", "TRS"));
                if (node != null) {
                    node.destroy();
                }

            }
            else if (CLastId[0] == 'S' && CLastId[1] == 'y') {
                var node = layer.findOne('#' + CLastId.replace("System", "TIC"));
                $("#SName").text("");
                $("#ICPD").hide();
                if (node != null) {
                    if (CurretIC != "") {
                        CurretIC = "";
                    }
                    $("#btn_IC *").prop('disabled', false);
                    node.destroy();
                }
            }
            else if (CLastId[0] == 'V') {


                var node = layer.findOne('#' + CLastId.replace("ValveBox", "TVB"));

                $("#SName").text("");
                $("#VBPD").hide();
                if (node != null) {
                    if (CurretVB != "") {
                        CurretVB = "";
                    }
                    $("#btn_VB *").prop('disabled', false);
                    node.destroy();
                }
            }
            else if (CLastId[0] == 'T' && CLastId[1] == 'a') {
                var node = layer.findOne('#' + CLastId.replace("Tap", "TTap"));
                $("#SName").text("");
                $("#TapPD").hide();
                if (node != null) {
                    if (CurretTap != "") {
                        CurretTap = "";
                    }
                    $("#btn_TAP *").prop('disabled', false);
                    node.destroy();
                }
            }
            var node = layer.findOne('#' + CLastId);
            if (node != null) {
                node.destroy();
            }

            var UniqueId = CLastId;
            var OrderId = $("#OrderId").val();


            UndoArray.pop();




            var model = {
                UniqueId: UniqueId,
                OrderId: OrderId,
            };

            $.ajax({
                type: "POST",
                url: "@Url.Action("DeleteOrderDetails", "Customer")",
                data: JSON.stringify(model),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (r) {
                    $("#TotalAmount").text(r);
                    $("#TotalAmountInput").val(r);
                }
            });

        }

    });


    function SetS(obj, Type) {
        if (Type<=3) {
            var SAID = $("#SId").val().replace("Sprinkler", "Arc");
            var SID = $("#SId").val();
            var SCID = $("#SId").val().replace("Sprinkler", "Circle");
            var SFCID = $("#SId").val().replace("Sprinkler", "FillCircle");
            var x1 = 0;
            var y1 = 0;
            var x2 = 0;
            var y2 = 0;
            var Sprinkler = layer.findOne('#' + SID);
            var ArcCir = layer.findOne('#' + SAID);
            var circle = layer.findOne('#' + SCID);
            var FillCircle = layer.findOne('#' + SFCID);
            if (Type == 1) {
                var oldRadius = Sprinkler.radius();

                ArcCir.innerRadius(MToPx(obj.value));
                Sprinkler.radius(MToPx(obj.value));
                var Distance = Sprinkler.radius();
                //var radius = Sprinkler.radius();
                x2 = Sprinkler.x();
                y2 = Sprinkler.y();

                x1 = circle.x();
                y1 = circle.y();


                dx = x1 - x2;
                dy = y1 - y2;


                var angleRad1 = Math.atan2(dy, dx);
                angleDeg1 = angleRad1 * 180 / Math.PI;
                angleDeg1 = (360 + (angleDeg1)) % 360;

                var DiffRadius = Number(Distance) - Number(oldRadius);
                console.log("Diffin Radius " + DiffRadius);
                console.log("Diffin Radius " + angleDeg1);


                SetWithangle(angleDeg1, DiffRadius, circle, Sprinkler);

                x1 = FillCircle.x();
                y1 = FillCircle.y();


                dx = x1 - x2;
                dy = y1 - y2;


                angleRad1 = Math.atan2(dy, dx);
                angleDeg1 = angleRad1 * 180 / Math.PI;
                angleDeg1 = (360 + (angleDeg1)) % 360;
                console.log("Diffin Radius " + DiffRadius);
                //console.log("Diffin Radius " + angleDeg1);


                SetWithangle(angleDeg1, DiffRadius, FillCircle, Sprinkler);




            }
            else if (Type == 2) {
                ArcCir.rotation(obj.value);
                ArcCir.angle(ArcCir.angle() - obj.value);


                //var radius = 60;
                //var angle = 140;
                //var x = radius * Math.sin(Math.PI * 2 * angle / 360);
                //var y = radius * Math.cos(Math.PI * 2 * angle / 360);
                //console.log('Points coors are  x=' +
                //    Math.round(x * 100) / 100 + ', y=' +
                //    Math.round(y * 100) / 100);


            }
            else if (Type == 3) {
                ArcCir.angle(obj.value);
            }
        }
        else if (Type<=5)
        {
            var SSID = $("#SSId").val();
            var Sprinkler = layer.findOne('#' + SSID);
            if (Type == 4) {
                Sprinkler.width(MToPx(obj.value));
            }
            else if (Type == 5) {
                Sprinkler.height(MToPx(obj.value));
            }
        }
        else if (Type==6)
        {
            $("#SubCatId").text(obj.value);
            $("#SName").text(obj.options[obj.selectedIndex].text);

        }
    }


    function SetWithangle(angleDeg2, DiffRadius, circle1, Sprinkler) {
        console.log("Values " + angleDeg2 + " " + DiffRadius + " " + Sprinkler.radius() + " " + circle1.x()+" " + circle1.y());
        if (angleDeg2 == 0) {
            //alert(0);
            circle1.x(Sprinkler.x() + Number(Sprinkler.radius()));
        }
        else if (angleDeg2 == 180) {
            circle1.x(Sprinkler.x() - Number(Sprinkler.radius()));

        }
        else if (angleDeg2 == 90) {
            circle1.y(Sprinkler.y() + Number(Sprinkler.radius()));
        }
            else if (angleDeg2 == 270) {
            circle1.y(Sprinkler.y() - Number(Sprinkler.radius()));

            }
        else if (angleDeg2 < 90) {
            //alert(0);
                var setx = Number(circle1.x()) + Number(DiffRadius);
                var sety = Number(circle1.y()) + Number(DiffRadius);
                circle1.x(setx);
            circle1.y(sety);
            console.log(circle1.x());
            console.log(circle1.y());
            }
            else if (angleDeg2 < 180) {
                var setx = Number(circle1.x()) - Number(DiffRadius);
                var sety = Number(circle1.y()) + Number(DiffRadius);
                circle1.x(setx);
                circle1.y(sety);
            }
            else if (angleDeg2 < 270) {
                var setx = Number(circle1.x()) - Number(DiffRadius);
                var sety = Number(circle1.y()) - Number(DiffRadius);
                circle1.x(setx);
                circle1.y(sety);
            }
            else if (angleDeg2 < 360) {

                var setx = Number(circle1.x()) + Number(DiffRadius);
                var sety = Number(circle1.y()) - Number(DiffRadius);
                circle1.x(setx);
                circle1.y(sety);
        }
        return 0;
    }


    document.getElementById('save').addEventListener('click', function () {
        var pdf = new jsPDF('l', 'px', [stage.width(), stage.height()+300]);
        pdf.setTextColor('#000000');
        // first add texts
        stage.find('Text').forEach((text) => {
            const size = text.fontSize() / 0.75; // convert pixels to points
            pdf.setFontSize(size);
            pdf.text(text.text(), text.x(), text.y(), {
                baseline: 'top',
                angle: -text.getAbsoluteRotation(),
            });
        });

        // then put image on top of texts (so texts are not visible)
        pdf.addImage(
            stage.toDataURL({ pixelRatio: 2 }),
            0,
            0,
            stage.width(),
            stage.height()
        );

        pdf.save('canvas.pdf');
    });


    function angle(cx, cy, ex, ey) {
        var dy = ey - cy;
        var dx = ex - cx;
        var theta = Math.atan2(dy, dx); // range (-PI, PI]
        theta *= 180 / Math.PI; // rads to degs, range (-180, 180]
        //if (theta < 0) theta = 360 + theta; // range [0, 360)
        return theta;
    }


    $("#file_input").change(function (e) {
        //var URL = window.webkitURL || window.URL;
        //var url = URL.createObjectURL(e.target.files[0]);
        //var img = new Image();
        //img.src = url;

        var FileName = "";

        var formData = new FormData();
        var fileInput = $("#file_input").get(0);
        var file = fileInput.files[0];
        formData.append("file", file);
        //console.log(file);
        //formData.append("InvoiceNum",5);
        //console.log(FormData);

        $.ajax({
            type: "POST",
            url: "@Url.Action("UploadDesignImg","Admin")",
            data: formData,
            processData: false,
            contentType: false,
            dataType: "json",
            success: function (r) {
                FileName = r;
                var Url = "/Uploading/" + FileName;
                console.log(Url);
                var imageObj = new Image();
                imageObj.onload = function () {
                    var yoda = new Konva.Image({
                        x: 200,
                        y: 100,
                        image: imageObj,
                        width: 350,
                        height: 300,
                        id:"UploadImg",
                        draggable: true,
                        opacity:1,
                    });

                    // add the shape to the layer
                    layer.add(yoda);
                    UndoArray.push(yoda.id());
                };
                //console.log(url);
                imageObj.src = Url;
                },
            error: function (r) {
                console.log(r);
                }
        });

        //$("#checkimg").src("/assets/images/ecommerce/ValveBox.png");
        /* $("#checkimg").attr("src", url);*/
        $("#file_input").prop('disabled', true);
        $("#DivImageOpacityValue").show();


    });

    $("body").on("change", "#ImageOpacityValue", function () {
        var node = layer.findOne('#UploadImg');
        //console.log(node);
        //console.log(this.value);
        node.opacity(this.value);
    });


    $(document).ready(function () {

        $(".nav1 li").removeClass("active");
        $('#DrawShape').addClass('active');

    });
</script>